# SAP_LLM Helm Chart Values
# Enterprise-grade configuration for production deployment

# Global configuration
global:
  environment: production  # production, staging, development
  region: us-east-1
  imageRegistry: ghcr.io
  imagePullSecrets:
    - name: ghcr-secret

# Application image configuration
image:
  repository: ghcr.io/ajithaccel4/sap_llm
  tag: "1.0.0"
  pullPolicy: IfNotPresent

# Replica configuration
replicaCount: 3

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# Horizontal Pod Autoscaler
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 50
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 80
  metrics:
    - type: Resource
      resource:
        name: nvidia.com/gpu
        target:
          type: Utilization
          averageUtilization: 85

# Resource requests and limits
resources:
  requests:
    cpu: "4"
    memory: "16Gi"
    nvidia.com/gpu: "1"  # Request 1 H100 GPU per pod
  limits:
    cpu: "8"
    memory: "32Gi"
    nvidia.com/gpu: "1"

# GPU configuration
gpu:
  enabled: true
  type: "nvidia-h100-80gb"
  driver: "535.104.05"  # NVIDIA driver version
  runtimeClass: nvidia

# Node selector for GPU nodes
nodeSelector:
  accelerator: nvidia-h100
  node-type: gpu-inference

# Tolerations for GPU nodes
tolerations:
  - key: nvidia.com/gpu
    operator: Equal
    value: "true"
    effect: NoSchedule

# Affinity rules
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - sap-llm
        topologyKey: kubernetes.io/hostname

# Service configuration
service:
  type: ClusterIP
  port: 8000
  targetPort: 8000
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/rate-limit: "1000"
  hosts:
    - host: sap-llm.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: sap-llm-tls
      hosts:
        - sap-llm.example.com

# Application configuration
config:
  # Model configuration
  model:
    name: "qwen25vl-sap-llm-v1"
    path: "/models/qwen25vl-sap-llm"
    quantization: "int8"  # none, int8, gptq4
    tensorrt: true
    batch_size: 4
    max_length: 2048

  # Inference server configuration
  triton:
    enabled: true
    instances: 2
    max_batch_size: 8
    preferred_batch_sizes: [4, 8]
    max_queue_delay_microseconds: 100

  # Process Memory Graph configuration
  pmg:
    enabled: true
    similarity_threshold: 0.85
    max_similar_documents: 10
    retraining_threshold: 500  # Min feedback samples for retraining

  # RLHF configuration
  rlhf:
    enabled: true
    reward_model_path: "/models/reward_model_v1"
    ppo_iterations: 1000
    learning_rate: 1e-6
    kl_penalty: 0.05

  # Self-Healing Workflow Loop configuration
  shwl:
    enabled: true
    anomaly_detection_interval: 300  # seconds
    contamination_rate: 0.05
    recovery_strategies:
      - retry_with_preprocessing
      - route_to_manual_review
      - apply_tolerance_rules

  # APOP configuration
  apop:
    enabled: true
    event_bus_type: kafka
    agent_heartbeat_ttl: 30
    dynamic_routing: true

  # Security configuration
  security:
    jwt_expiration: 3600  # 1 hour
    refresh_token_expiration: 604800  # 7 days
    api_key_rotation_days: 90
    encryption_algorithm: "AES-256-GCM"
    tls_version: "1.3"

  # Logging configuration
  logging:
    level: INFO
    format: json
    output: stdout

  # Monitoring configuration
  monitoring:
    enabled: true
    prometheus_port: 9090
    jaeger_enabled: true
    tracing_sample_rate: 0.1

# Redis configuration (for caching and coordination)
redis:
  enabled: true
  architecture: replication
  master:
    persistence:
      enabled: true
      size: 50Gi
  replica:
    replicaCount: 2
    persistence:
      enabled: true
      size: 50Gi
  auth:
    enabled: true
    existingSecret: sap-llm-redis-secret

# Neo4j configuration (Process Memory Graph)
neo4j:
  enabled: true
  core:
    numberOfServers: 3
  readReplica:
    numberOfServers: 2
  volumes:
    data:
      mode: dynamic
      dynamic:
        storageClassName: fast-ssd
        requests:
          storage: 500Gi
  dbms:
    memory:
      heap:
        initial_size: "16G"
        max_size: "32G"
      pagecache:
        size: "16G"
  services:
    neo4j:
      enabled: true
      spec:
        type: ClusterIP
  config:
    dbms.security.auth_enabled: "true"
    dbms.connector.bolt.thread_pool_max_size: "400"
  existingPasswordSecret: sap-llm-neo4j-secret

# Kafka configuration (Event bus for APOP)
kafka:
  enabled: true
  replicaCount: 3
  persistence:
    enabled: true
    size: 500Gi
    storageClass: fast-ssd
  zookeeper:
    enabled: true
    replicaCount: 3
    persistence:
      enabled: true
      size: 100Gi
  kraft:
    enabled: false
  listeners:
    client:
      protocol: PLAINTEXT
    controller:
      protocol: PLAINTEXT
    interbroker:
      protocol: PLAINTEXT
  auth:
    clientProtocol: sasl
    interBrokerProtocol: sasl
    sasl:
      mechanism: scram-sha-512
  externalAccess:
    enabled: false

# Qdrant configuration (Vector database for PMG)
qdrant:
  enabled: true
  replicaCount: 3
  persistence:
    enabled: true
    size: 200Gi
    storageClass: fast-ssd
  resources:
    requests:
      cpu: "2"
      memory: "8Gi"
    limits:
      cpu: "4"
      memory: "16Gi"

# MinIO configuration (Object storage for documents)
minio:
  enabled: true
  mode: distributed
  replicas: 4
  persistence:
    enabled: true
    size: 2Ti
    storageClass: standard
  resources:
    requests:
      cpu: "1"
      memory: "4Gi"
  auth:
    existingSecret: sap-llm-minio-secret

# PostgreSQL configuration (Metadata storage)
postgresql:
  enabled: true
  architecture: replication
  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd
  readReplicas:
    replicaCount: 2
    persistence:
      enabled: true
      size: 100Gi
  auth:
    existingSecret: sap-llm-postgres-secret
  metrics:
    enabled: true

# Persistent volumes
persistence:
  models:
    enabled: true
    storageClass: fast-ssd
    accessMode: ReadOnlyMany
    size: 500Gi
    mountPath: /models
  data:
    enabled: true
    storageClass: standard
    accessMode: ReadWriteMany
    size: 2Ti
    mountPath: /data
  cache:
    enabled: true
    storageClass: fast-ssd
    accessMode: ReadWriteMany
    size: 200Gi
    mountPath: /cache

# Health checks
livenessProbe:
  httpGet:
    path: /health
    port: 8000
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Pod security context
podSecurityContext:
  seccompProfile:
    type: RuntimeDefault

# Service account
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/sap-llm-role
  name: sap-llm

# RBAC
rbac:
  create: true
  rules:
    - apiGroups: [""]
      resources: ["configmaps", "secrets"]
      verbs: ["get", "list", "watch"]

# Network policies
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 80
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        - podSelector:
            matchLabels:
              app: neo4j
      ports:
        - protocol: TCP
          port: 7687
    - to:
        - podSelector:
            matchLabels:
              app: kafka
      ports:
        - protocol: TCP
          port: 9092

# Monitoring and observability
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 15s
    scrapeTimeout: 10s
  rules:
    enabled: true
    alerts:
      - name: HighErrorRate
        expr: rate(sap_llm_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        severity: critical
      - name: HighLatency
        expr: histogram_quantile(0.95, sap_llm_request_duration_seconds_bucket) > 2
        for: 5m
        severity: warning
      - name: LowExtractionAccuracy
        expr: sap_llm_extraction_f1_score < 0.95
        for: 15m
        severity: critical

grafana:
  enabled: true
  dashboards:
    enabled: true

jaeger:
  enabled: true
  agent:
    enabled: true
  collector:
    enabled: true
  query:
    enabled: true

# Backup configuration
backup:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention: 30  # days
  destinations:
    - type: s3
      bucket: sap-llm-backups
      region: us-east-1

# Canary deployment configuration
canary:
  enabled: false
  weight: 10  # Percentage of traffic to canary
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    metrics:
      - name: request-success-rate
        threshold: 99
      - name: request-duration
        threshold: 2000  # ms

# Feature flags
features:
  pmg_enabled: true
  rlhf_enabled: true
  shwl_enabled: true
  apop_enabled: true
  multilingual_enabled: false
  federated_learning_enabled: false
  online_learning_enabled: false

# Environment-specific overrides
envOverrides:
  production:
    replicaCount: 10
    resources:
      requests:
        cpu: "8"
        memory: "32Gi"
  staging:
    replicaCount: 3
    resources:
      requests:
        cpu: "4"
        memory: "16Gi"
  development:
    replicaCount: 1
    resources:
      requests:
        cpu: "2"
        memory: "8Gi"
        nvidia.com/gpu: "0"
