# Dependency Management Guide

## Overview

This document describes the dependency management strategy for the SAP LLM project. We use exact version pinning to ensure reproducible builds and prevent unexpected breaking changes.

## Table of Contents

1. [Dependency Files](#dependency-files)
2. [Installation](#installation)
3. [Updating Dependencies](#updating-dependencies)
4. [Security Scanning](#security-scanning)
5. [Testing](#testing)
6. [Rollback Procedure](#rollback-procedure)
7. [Best Practices](#best-practices)

## Dependency Files

### Core Files

- **`requirements.txt`**: Production dependencies with exact version pinning (`==`)
  - All packages are pinned to specific versions
  - Organized by category (ML frameworks, APIs, databases, etc.)
  - Used for production deployments

- **`requirements-lock.txt`**: Complete lock file generated by `pip freeze`
  - Includes all transitive dependencies
  - Should be regenerated when dependencies are updated
  - Provides complete reproducibility

- **`requirements-dev.txt`**: Development dependencies
  - Includes all tools for development (linters, formatters, type checkers)
  - Documentation generators
  - Debugging and profiling tools
  - Includes production dependencies via `-r requirements.txt`

- **`requirements-test.txt`**: Testing dependencies
  - Testing frameworks (pytest and plugins)
  - Mocking libraries
  - Test data generators
  - Includes production dependencies via `-r requirements.txt`

- **`pyproject.toml`**: Modern Python packaging configuration
  - Project metadata
  - Exact dependency specifications
  - Optional dependencies (dev, test, gpu)
  - Tool configurations (black, ruff, mypy, pytest)

## Installation

### Production Environment

```bash
# Create and activate virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install production dependencies
pip install --upgrade pip setuptools wheel
pip install -r requirements.txt

# Verify installation
python scripts/verify_dependencies.py
```

### Development Environment

```bash
# Create and activate virtual environment
python -m venv venv
source venv/bin/activate

# Install development dependencies
pip install --upgrade pip setuptools wheel
pip install -r requirements-dev.txt

# Install pre-commit hooks
pre-commit install

# Verify installation
python scripts/verify_dependencies.py
```

### Testing Environment

```bash
# Create and activate virtual environment
python -m venv venv
source venv/bin/activate

# Install test dependencies
pip install --upgrade pip setuptools wheel
pip install -r requirements-test.txt

# Run tests
pytest
```

### Using pyproject.toml (Recommended)

```bash
# Install production dependencies
pip install -e .

# Install with development dependencies
pip install -e ".[dev]"

# Install with test dependencies
pip install -e ".[test]"

# Install with all optional dependencies
pip install -e ".[all]"

# Install with GPU support
pip install -e ".[gpu]"
```

## Updating Dependencies

### Process Overview

1. **Research**: Understand why the update is needed
2. **Test**: Update in isolated environment and test thoroughly
3. **Security Review**: Check for known vulnerabilities
4. **Update**: Modify dependency files
5. **Verify**: Run full test suite
6. **Document**: Record changes in CHANGELOG

### Step-by-Step Update Process

#### 1. Create Update Branch

```bash
git checkout -b update-dependencies-YYYY-MM-DD
```

#### 2. Update Single Dependency

```bash
# Research latest version
pip index versions <package-name>

# Update in requirements.txt
# Change: torch==2.1.0
# To:     torch==2.2.0

# Update in pyproject.toml as well
```

#### 3. Test in Isolated Environment

```bash
# Create clean test environment
python -m venv test_env
source test_env/bin/activate

# Install updated dependencies
pip install -r requirements.txt

# Run verification script
python scripts/verify_dependencies.py

# Run full test suite
pytest

# Run specific integration tests
pytest -m integration

# Check for dependency conflicts
pip check
```

#### 4. Regenerate Lock File

```bash
# With dependencies installed in clean environment
pip freeze > requirements-lock.txt

# Review changes
git diff requirements-lock.txt
```

#### 5. Security Review

```bash
# Run security scanners
pip-audit -r requirements.txt
safety check -r requirements.txt

# Check CVE databases manually if needed
```

#### 6. Update Documentation

```bash
# Update CHANGELOG.md with dependency changes
# Document any breaking changes
# Update version compatibility notes
```

#### 7. Create Pull Request

```bash
git add requirements.txt requirements-lock.txt pyproject.toml
git commit -m "chore: Update dependencies - YYYY-MM-DD"
git push origin update-dependencies-YYYY-MM-DD

# Create PR with detailed description of changes
```

### Bulk Dependency Updates

For updating multiple dependencies:

```bash
# Create requirements-new.txt with updated versions
# Test extensively in isolated environment
python -m venv bulk_test_env
source bulk_test_env/bin/activate

pip install -r requirements-new.txt

# Run comprehensive test suite
pytest -v --cov

# Run performance benchmarks
pytest -m benchmark

# If all tests pass, replace requirements.txt
mv requirements-new.txt requirements.txt

# Regenerate lock file
pip freeze > requirements-lock.txt
```

## Security Scanning

### Automated Scanning

The project uses GitHub Actions for automated security scanning:

- **Daily scans**: Runs at 2 AM UTC
- **PR scans**: Runs on every pull request that modifies dependencies
- **Push scans**: Runs on pushes to main/develop branches

### Manual Scanning

#### Using pip-audit

```bash
# Install pip-audit
pip install pip-audit==2.6.3

# Scan production dependencies
pip-audit -r requirements.txt

# Scan with detailed output
pip-audit -r requirements.txt --desc

# Output to JSON
pip-audit -r requirements.txt --format json --output audit-report.json
```

#### Using Safety

```bash
# Install Safety
pip install safety==3.0.1

# Basic scan
safety check -r requirements.txt

# Full report
safety check -r requirements.txt --full-report

# Output to JSON
safety check -r requirements.txt --json --output safety-report.json
```

#### Using Bandit (Code Security)

```bash
# Install Bandit
pip install bandit==1.7.6

# Scan codebase
bandit -r sap_llm/

# Generate HTML report
bandit -r sap_llm/ -f html -o bandit-report.html
```

### Vulnerability Response Process

1. **Detection**: Automated scan or manual discovery
2. **Assessment**: Evaluate severity and impact
3. **Prioritization**: Critical > High > Medium > Low
4. **Remediation**:
   - Update to patched version
   - Apply workarounds if no patch available
   - Remove dependency if possible
5. **Testing**: Verify fix doesn't break functionality
6. **Deployment**: Deploy updated dependencies
7. **Documentation**: Document in security log

### Severity Response Times

- **Critical**: Immediate (within 24 hours)
- **High**: Within 1 week
- **Medium**: Within 1 month
- **Low**: Next regular update cycle

## Testing

### Pre-Update Testing Checklist

- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] Performance benchmarks show no regression
- [ ] Security scans show no new vulnerabilities
- [ ] Documentation is updated
- [ ] CHANGELOG is updated

### Test Commands

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=sap_llm --cov-report=html

# Run specific test categories
pytest -m unit           # Unit tests only
pytest -m integration    # Integration tests only
pytest -m "not slow"     # Skip slow tests

# Run tests in parallel
pytest -n auto

# Run with verbose output
pytest -v

# Run specific test file
pytest tests/test_dependencies.py
```

### Dependency Verification

```bash
# Run verification script
python scripts/verify_dependencies.py

# Check for conflicts
pip check

# List installed packages
pip list

# Show dependency tree
pip install pipdeptree
pipdeptree
```

## Rollback Procedure

### Quick Rollback

```bash
# Checkout previous version of requirements files
git checkout HEAD~1 requirements.txt requirements-lock.txt pyproject.toml

# Reinstall dependencies
pip install --force-reinstall -r requirements.txt

# Verify
python scripts/verify_dependencies.py
pytest
```

### Full Rollback Process

1. **Identify Issue**: Document what went wrong
2. **Stop Deployment**: Halt any in-progress deployments
3. **Restore Files**: Checkout previous working versions
4. **Reinstall**: Clean install of previous dependencies
5. **Verify**: Run full test suite
6. **Deploy**: Deploy rolled-back version
7. **Post-Mortem**: Document issue and prevention steps

### Version Control for Rollback

```bash
# View dependency file history
git log --oneline -- requirements.txt

# Show specific version
git show <commit-hash>:requirements.txt

# Checkout specific version
git checkout <commit-hash> -- requirements.txt requirements-lock.txt

# Create rollback branch
git checkout -b rollback-dependencies-<date>
git add requirements.txt requirements-lock.txt pyproject.toml
git commit -m "chore: Rollback dependencies to <date>"
```

## Best Practices

### Version Pinning

✅ **DO:**
- Use exact version pinning (`==`) in all requirements files
- Pin transitive dependencies in lock file
- Document why specific versions are chosen
- Test on all supported Python versions (3.9, 3.10, 3.11)

❌ **DON'T:**
- Use minimum version specifiers (`>=`)
- Use compatible release specifiers (`~=`)
- Leave versions unpinned
- Install from `@main` or `@master` branches

### Dependency Sources

✅ **DO:**
- Install from PyPI when possible
- Pin git dependencies to specific tags or commit hashes
- Verify package checksums
- Use private package indexes for internal packages

❌ **DON'T:**
- Install from unverified sources
- Use `@main` or `@master` for git dependencies
- Skip checksum verification
- Mix package sources unnecessarily

### Update Frequency

- **Security updates**: Immediate when critical
- **Minor updates**: Monthly review
- **Major updates**: Quarterly or as needed
- **Python version**: Annually or when needed

### Documentation

✅ **DO:**
- Document all dependency changes in CHANGELOG
- Explain why specific versions are chosen
- Note any known issues or workarounds
- Keep compatibility matrix updated

❌ **DON'T:**
- Make undocumented changes
- Skip CHANGELOG updates
- Ignore breaking changes
- Leave TODOs without context

### Testing

✅ **DO:**
- Test on all supported platforms
- Run full test suite before updating
- Test in clean environment
- Verify backward compatibility

❌ **DON'T:**
- Skip tests for "minor" updates
- Test only on development machine
- Assume updates are backward compatible
- Deploy without testing

## Python Version Compatibility

The project supports Python 3.9, 3.10, and 3.11.

### Version-Specific Notes

**Python 3.9:**
- Minimum supported version
- All features should work
- Some type hints may need adjustments

**Python 3.10:**
- Recommended for development
- Full feature support
- Better type checking

**Python 3.11:**
- Latest supported version
- Best performance
- Most recent language features

### Testing Across Versions

```bash
# Using tox (if configured)
tox

# Manual testing
for version in 3.9 3.10 3.11; do
    pyenv local $version
    python -m venv venv-$version
    source venv-$version/bin/activate
    pip install -r requirements.txt
    pytest
    deactivate
done
```

## License Compliance

All dependencies must be compatible with commercial use.

### Approved Licenses

- MIT
- Apache 2.0
- BSD (2-clause, 3-clause)
- ISC
- Python Software Foundation

### Restricted Licenses

- GPL (any version) - Requires legal review
- AGPL (any version) - Generally not allowed
- Custom licenses - Requires legal review

### Checking Licenses

```bash
# Install pip-licenses
pip install pip-licenses==4.3.3

# List all licenses
pip-licenses

# Export to file
pip-licenses --format=markdown --output-file=licenses.md

# Check for specific licenses
pip-licenses --fail-on GPL-2.0 --fail-on GPL-3.0 --fail-on AGPL-3.0
```

## Troubleshooting

### Common Issues

#### Dependency Conflict

```bash
# Problem: pip reports dependency conflicts
# Solution:
pip install --upgrade pip
pip check
pipdeptree --warn conflicts

# If conflicts persist:
# 1. Review conflicting packages
# 2. Update to compatible versions
# 3. Remove unnecessary dependencies
```

#### Installation Timeout

```bash
# Problem: Large packages timeout during installation
# Solution:
pip install --timeout 300 -r requirements.txt

# Or install large packages separately:
pip install torch==2.1.0 --timeout 600
pip install -r requirements.txt
```

#### Platform-Specific Issues

```bash
# macOS: OpenCV issues
brew install opencv

# Linux: System dependencies
sudo apt-get install python3-dev libpq-dev

# Windows: Compiler issues
# Install Visual C++ Build Tools
```

## Support

For dependency-related issues:

1. Check this documentation
2. Review closed issues on GitHub
3. Run `scripts/verify_dependencies.py`
4. Create issue with full details:
   - Python version
   - Operating system
   - Full error message
   - Steps to reproduce

## References

- [PyPI](https://pypi.org/)
- [pip Documentation](https://pip.pypa.io/)
- [Python Packaging Guide](https://packaging.python.org/)
- [pip-audit](https://github.com/pypa/pip-audit)
- [Safety](https://github.com/pyupio/safety)
- [PEP 631 - Dependency specification in pyproject.toml](https://peps.python.org/pep-0631/)
