name: Performance Benchmarks

on:
  # Run weekly on Sunday at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      quick_mode:
        description: 'Run in quick mode (reduced iterations)'
        required: false
        default: 'true'

  # Run on push to main (optional)
  # push:
  #   branches: [ main ]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/benchmarks/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r benchmarks/requirements.txt

    - name: Run benchmarks
      run: |
        if [ "${{ github.event.inputs.quick_mode }}" == "true" ]; then
          python benchmarks/scripts/run_all_benchmarks.py --quick --output-dir benchmarks/results
        else
          python benchmarks/scripts/run_all_benchmarks.py --output-dir benchmarks/results
        fi

    - name: Generate report
      run: |
        python benchmarks/scripts/generate_report.py \
          --results benchmarks/results \
          --output docs/PERFORMANCE_REPORT.md

    - name: Check for regressions
      id: regression_check
      run: |
        python benchmarks/scripts/check_regressions.py \
          --current benchmarks/results \
          --baseline benchmarks/baseline \
          --threshold 0.10
      continue-on-error: true

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: |
          benchmarks/results/*.json
          docs/PERFORMANCE_REPORT.md
        retention-days: 90

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('docs/PERFORMANCE_REPORT.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## Performance Benchmark Results\n\n' + report
          });

    - name: Fail on regression
      if: steps.regression_check.outcome == 'failure'
      run: |
        echo "Performance regression detected!"
        exit 1

    - name: Commit results to history
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        mkdir -p benchmarks/history
        cp benchmarks/results/combined_*.json benchmarks/history/

        git add benchmarks/history/
        git add docs/PERFORMANCE_REPORT.md
        git commit -m "chore: Add benchmark results $(date +%Y-%m-%d)" || echo "No changes to commit"
        git push || echo "Nothing to push"
